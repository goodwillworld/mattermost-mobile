  workflows:
  mattermost_whitelabel_ios:
    name: Mattermost WhiteLabel iOS (TestFlight/App Store)
    max_build_duration: 120
    instance_type: mac_mini_m2

    environment:
      xcode: 16.4
      cocoapods: default
      # å¦‚éœ€åœ¨ Codemagic ä¸­æ”¾å¯†é’¥ï¼Œè¯·åœ¨ UI çš„ Environment variables é‡Œæ·»åŠ ï¼Œä¸è¦å†™åœ¨æ–‡ä»¶ä¸­
      vars:
        FASTLANE_SKIP_UPDATE_CHECK: "1"
        MATCH_READONLY: "true"
        # ä½ çš„ Fastfile/Matchfile å·²ç»æŒ‡å‘ä»“åº“ ios-certs.git å’Œåˆ†æ”¯ master
        # å¦‚è¦è¦†ç›–ï¼Œå¯åœ¨ Codemagic UI é‡Œè®¾ç½®ä»¥ä¸‹å˜é‡ï¼ˆå¯é€‰ï¼‰ï¼š
        # MATCH_GIT_URL: "https://github.com/goodwillworld/ios-certs.git"
        # MATCH_GIT_BRANCH: "master"
        # ä¹Ÿå¯ä»¥åœ¨ UI é‡Œè®¾ç½® FASTLANE_USER / FASTLANE_PASSWORD / APP_STORE_CONNECT_API_KEY_* ç­‰ï¼ˆå¦‚æœéœ€è¦ï¼‰

    cache:
      cache_paths:
        - $HOME/Library/Caches/CocoaPods
        - ios/Pods
        - $HOME/Library/Developer/Xcode/DerivedData
        - $HOME/.gradle/caches # æ— ä¼¤é¡¹ï¼Œä¾¿äºåç»­å¤ç”¨

    scripts:
      - name: Select Ruby (best effort)
        script: |
          rbenv local 3.3.6 || true
          ruby -v
          gem -v
          bundle -v || true

      - name: Install JS dependencies
        script: |
          node -v
          npm -v
          npm ci

      - name: Pod install (with Bundler if Gemfile exists)
        script: |
          cd ios
          if [ -f "../Gemfile" ]; then
            bundle install --path vendor/bundle
            bundle exec pod install
          else
            pod install
          fi

      - name: ğŸ”§ Patch Pods project for TurboLogIOSNative (remove module.modulemap from Compile Sources)
        script: |
          set -e
          cd ios
          ruby - <<'RUBY'
            require 'xcodeproj'
            proj_path = 'Pods/Pods.xcodeproj'
            unless File.exist?(proj_path)
              puts "âš ï¸ #{proj_path} not found, skip patch"
              exit 0
            end
            proj = Xcodeproj::Project.open(proj_path)
            target = proj.targets.find { |t| t.name == 'TurboLogIOSNative' }
            if target.nil?
              puts "â„¹ï¸ Target TurboLogIOSNative not found, skip patch"
              exit 0
            end
            removed = 0
            # å…¼å®¹ä¸åŒç‰ˆæœ¬ APIï¼šsource_build_phase / sources_build_phase
            src_phase = target.respond_to?(:source_build_phase) ? target.source_build_phase : target.sources_build_phase
            src_files = src_phase.files

            # ç§»é™¤è¯¯åŠ åˆ° Compile Sources çš„ä»»ä½• *.modulemapï¼Œé‡ç‚¹æ˜¯ TurboLogSwift/module.modulemap
            src_files.select { |f|
              path = f.file_ref&.path.to_s
              path.end_with?('TurboLogSwift/module.modulemap') || path.end_with?('.modulemap')
            }.each do |f|
              src_phase.remove_file_reference(f.file_ref)
              removed += 1
            end

            # æ˜¾å¼æŒ‡å®š MODULEMAP_FILEï¼Œé¿å…æ„å»ºå™¨è¯¯å¤„ç†
            target.build_configurations.each do |cfg|
              cfg.build_settings['MODULEMAP_FILE'] = '$(SRCROOT)/TurboLogIOSNative/Sources/TurboLogSwift/module.modulemap'
            end

            proj.save
            puts "âœ… Removed #{removed} .modulemap from Compile Sources & set MODULEMAP_FILE"
          RUBY
          cd ..

      - name: Build via fastlane (app-store)
        script: |
          # ä½¿ç”¨ä½ ä»“åº“é‡Œçš„ Fastlaneã€‚ä½ çš„ Fastfile å·²ç»æŠŠå¯¼å‡ºæ–¹å¼åˆ‡åˆ° app-storeï¼ˆæˆ–ç”±ç¯å¢ƒå¯¼å‡ºï¼‰
          bundle install || true
          # å¼ºåˆ¶èµ° app-storeï¼Œä»¥åŒ¹é… match AppStore ... çš„æè¿°æ–‡ä»¶
          export EXPORT_METHOD=app-store
          bundle exec fastlane ios build

    artifacts:
      - "**/*.ipa"
      - "**/*.xcarchive"
      - "**/dSYM.zip"
      - "fastlane/report.xml"
      - "~/Library/Logs/gym/*.log"

    publishing:
      email:
        recipients:
          - "844655188@qq.com"
        notify:
          success: true
          failure: true
