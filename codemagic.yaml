workflows:
  mm-whitelabel-ios:
    name: "Mattermost WhiteLabel iOS (TestFlight/App Store)"
    max_build_duration: 120
    environment:
      vars:
        # ä¸ºäº†ä¸å®‰è£…çš„ App Store ç±»å‹ provisioning profiles ä¿æŒä¸€è‡´ï¼Œå¼ºåˆ¶ä½¿ç”¨ app-store å¯¼å‡ºæ–¹å¼
        EXPORT_METHOD: app-store
      groups:
        - ios_match
        - whitelabel_common
        - whitelabel_ios
      xcode: latest
      cocoapods: default
      node: 20.12.2
      npm: 10.5.0
      ruby: 3.3.6
      gem: 3.5.15
    cache:
      cache_paths:
        - $HOME/Library/Caches/CocoaPods
        - $HOME/Library/MobileDevice/Provisioning Profiles
        - $CM_BUILD_DIR/node_modules
        - $CM_BUILD_DIR/ios/Pods
        - $CM_BUILD_DIR/ios/build
        - $HOME/Library/Caches/bundle
      pre_build_scripts_cache_key: v1-ios-mm-whitelabel
    scripts:
      - name: Ruby/Fastlane + CocoaPodsï¼ˆå›ºå®šç‰ˆæœ¬ 1.16.1ï¼‰
        script: |
          set -euo pipefail
          echo ">> å®‰è£… CocoaPods 1.16.1 ä¸ bundler"
          gem install cocoapods -v 1.16.1 --no-document
          gem install bundler --no-document
          echo "ruby -v: $(ruby -v)"
          echo "gem -v: $(gem -v)"
          echo "pod --version: $(pod --version)"
      - name: pods å®‰è£…ï¼ˆpod installï¼‰
        script: |
          set -euo pipefail
          cd ios
          # ä½¿ç”¨é¡¹ç›® Podfile.lock æŒ‡å®šç‰ˆæœ¬ï¼ˆå¦‚æœ‰ï¼‰ï¼Œé¿å…æ¼‚ç§»
          pod repo update --silent || true
          pod install --repo-update
          cd -
      - name: pods å®‰è£…ä¸åˆå§‹åŒ–ï¼ˆPod install + match readonlyï¼‰
        script: |
          set -euo pipefail
          # è¿™é‡Œå¦‚æœä½ çš„ä»“åº“è„šæœ¬ä¼šæ‰§è¡Œ match/è¯ä¹¦åˆå§‹åŒ–ï¼Œå¯ä¿ç•™ã€‚è‹¥æ²¡æœ‰ï¼Œå¯å¿½ç•¥ã€‚
          echo ">>ï¼ˆå¯é€‰ï¼‰æ­¤å¤„æ‰§è¡Œè¯ä¹¦/æè¿°æ–‡ä»¶çš„åˆå§‹åŒ–é€»è¾‘"
          # ç¤ºä¾‹ï¼š
          # bundle install
          # bundle exec fastlane ios certificates
      - name: "ğŸ”§ Patch Pods project for TurboLogIOSNative (remove .modulemap from Compile Sources)"
        script: |
          set -e
          cd ios
          ruby - <<'RUBY'
          require 'xcodeproj'
          proj = Xcodeproj::Project.open('Pods/Pods.xcodeproj')
          t = proj.targets.find { |x| x.name == 'TurboLogIOSNative' }
          if t
            # å…¼å®¹ä¸åŒ xcodeproj ç‰ˆæœ¬ä¸‹çš„æ–¹æ³•åå·®å¼‚
            phase = if t.respond_to?(:sources_build_phase)
              t.sources_build_phase
            elsif t.respond_to?(:source_build_phase)
              t.source_build_phase
            else
              nil
            end

            removed = 0
            if phase
              phase.files.each do |bf|
                fr = bf.file_ref
                next unless fr && fr.path
                if fr.path.end_with?('TurboLogSwift/module.modulemap') || fr.path.end_with?('module.modulemap')
                  phase.remove_file_reference(fr)
                  removed += 1
                end
              end
            end

            # æ˜¾å¼è®¾ç½® MODULEMAP_FILEï¼ˆä¿æŒæ­£ç¡®ä½ç½®ï¼‰
            t.build_configurations.each do |cfg|
              cfg.build_settings['MODULEMAP_FILE'] = '$(SRCROOT)/TurboLogIOSNative/Sources/TurboLogSwift/module.modulemap'
            end

            proj.save
            puts "âœ… Removed #{removed} *.modulemap from Compile Sources in TurboLogIOSNative"
          else
            puts "â„¹ï¸ Target TurboLogIOSNative not found"
          end
          RUBY
          cd ..
      - name: "ğŸ” Assert: no .modulemap left in Compile Sources"
        script: |
          set -e
          cd ios
          ruby - <<'RUBY'
          require 'xcodeproj'
          proj = Xcodeproj::Project.open('Pods/Pods.xcodeproj')
          errors = []
          proj.targets.each do |t|
            phase = if t.respond_to?(:sources_build_phase)
              t.sources_build_phase
            elsif t.respond_to?(:source_build_phase)
              t.source_build_phase
            else
              nil
            end
            next unless phase
            phase.files.each do |bf|
              fr = bf.file_ref
              if fr && fr.path && fr.path.end_with?('module.modulemap')
                errors << "#{t.name}: #{fr.path}"
              end
            end
          end

          if errors.any?
            warn "Found modulemap in Compile Sources:\n  - " + errors.join("\n  - ")
            exit 1
          else
            puts "âœ… No module.modulemap in any Compile Sources"
          end
          RUBY
          cd ..
      - name: æ›¿æ¢ç™½æ ‡èµ„æºä¸é…ç½®ï¼ˆicons / splash / bundle id ç­‰ï¼‰
        script: |
          set -euo pipefail
          echo ">> è¿™é‡Œä¿ç•™ä½ åŸå…ˆçš„èµ„æºæ›¿æ¢ã€Info.plist è°ƒæ•´ã€entitlementsã€Team ID ç­‰è„šæœ¬"
          # æŒ‰ä½ ä»“åº“é‡Œçš„é€»è¾‘æ‰§è¡Œ
      - name: æ‰“å°å¿…é¡»çš„ç¯å¢ƒå˜é‡ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
        script: |
          set -euo pipefail
          echo "CM_REPO_SLUG=${CM_REPO_SLUG}"
          echo "APP_DISPLAY_NAME=${APP_DISPLAY_NAME}"
          echo "BUNDLE_ID=${BUNDLE_ID}"
          echo "BUNDLE_ID_SHARE=${BUNDLE_ID_SHARE}"
          echo "BUNDLE_ID_NOTI=${BUNDLE_ID_NOTI}"
          echo "TEAM_ID=${TEAM_ID}"
          echo "PROVISIONING_GIT_URL å·²åœ¨ç»„å˜é‡ä¸­è®¾ç½®"
          echo "EXPORT_METHOD=${EXPORT_METHOD}"
      - name: æ„å»º iOSï¼ˆä½¿ç”¨ä»“åº“ laneï¼‰
        script: |
          set -euo pipefail
          # ç”±ä»“åº“ä¸­çš„è„šæœ¬è§¦å‘ fastlaneï¼Œå†…éƒ¨åº”è¯»å– EXPORT_METHOD=app-store
          npm run build:ios
      - name: æ”¶é›†åˆ¶å“
        script: |
          set -euo pipefail
          mkdir -p build_outputs
          # iPA / dSYM / xcarchive çš„è·¯å¾„æŒ‰ä½ ä»“åº“çš„è¾“å‡ºæ”¾ç½®
          # ä¸¾ä¾‹ï¼š
          # cp ./ios/*.ipa build_outputs/ || true
          # cp -R ~/Library/Developer/Xcode/Archives/*/*.xcarchive build_outputs/ || true
    artifacts:
      - build_outputs/**/*
    publishing:
      email:
        recipients:
          - $EMAIL_TO
  mm-whitelabel-android:
    name: "Mattermost WhiteLabel Android"
    max_build_duration: 120
    environment:
      groups:
        - whitelabel_common
        - whitelabel_android
      node: 20.12.2
      npm: 10.5.0
      java: 17
    scripts:
      - name: å®‰è£…ä¾èµ–
        script: |
          set -euo pipefail
          npm ci
      - name: æ„å»º Androidï¼ˆä½¿ç”¨ä»“åº“è„šæœ¬ï¼‰
        script: |
          set -euo pipefail
          npm run build:android
    artifacts:
      - android_build_outputs/**/*
    publishing:
      email:
        recipients:
          - $EMAIL_TO
