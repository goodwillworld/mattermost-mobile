workflows:
  # ========= ANDROIDï¼šç™½æ ‡ + ç”Ÿæˆ APKï¼ˆè‡ªè¡Œåˆ†å‘ï¼‰ï¼Œä¸å‘å¸ƒåˆ°å•†åº— =========
  mm-whitelabel-android-sideload:
    name: Mattermost WhiteLabel ANDROID (sideload)
    max_build_duration: 120
    instance_type: linux_x2
    environment:
      android_signing:
        - jboth_android_keystore_ref   # åœ¨ Team settings â†’ codemagic.yaml settings â†’ Code signing identities ä¸Šä¼ åŽå¾—åˆ°çš„å¼•ç”¨å
      groups:
        - mm_common                    # é€šç”¨å˜é‡ç»„ï¼šREPLACE_ASSETSã€APP_SCHEMEã€ç­‰
        - jboth_client                 # å®¢æˆ·å˜é‡ç»„ï¼šAPP_NAMEã€MAIN_APP_IDENTIFIER ç­‰
      vars:
        BUILD_FOR_RELEASE: "true"
        ANDROID_BUILD_TASK: "assemble" # assemble=APKï¼›bundle=AAB
        REPLACE_ASSETS: "true"
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - node_modules
    scripts:
      - name: Node çŽ¯å¢ƒä¸Žä¾èµ–
        script: |
          set -e
          if [ -f ".nvmrc" ]; then . $HOME/.nvm/nvm.sh && nvm install && nvm use; fi
          npm ci

      - name: æ³¨å…¥ç­¾åï¼ˆGradleï¼‰
        script: |
          mkdir -p $HOME/.gradle
          cat >> $HOME/.gradle/gradle.properties <<EOF
          MATTERMOST_RELEASE_STORE_FILE=$CM_KEYSTORE_PATH
          MATTERMOST_RELEASE_KEY_ALIAS=$CM_KEY_ALIAS
          MATTERMOST_RELEASE_PASSWORD=$CM_KEY_PASSWORD
          EOF

      - name: å†™å…¥/å…œåº•é»˜è®¤æœåŠ¡å™¨é…ç½®ï¼ˆå¦‚ä»“åº“ä¸­å·²å­˜åœ¨å°†ä¸ä¼šè¦†ç›–ï¼‰
        script: |
          set -e
          mkdir -p assets/override
          CFG=assets/override/config.json
          if [ ! -f "$CFG" ]; then
            cat > "$CFG" <<'JSON'
          {
            "DefaultServerUrl": "https://hello.jboth.com",
            "AutoSelectServerUrl": true
          }
          JSON
            echo "Created $CFG with default server URL."
          else
            echo "Found existing $CFG, keep your repo version."
          fi

      - name: ç™½æ ‡å˜é‡ç¡®è®¤
        script: |
          echo "APP_NAME=$APP_NAME"
          echo "MAIN_APP_IDENTIFIER=$MAIN_APP_IDENTIFIER"
          echo "APP_SCHEME=$APP_SCHEME"

      - name: æž„å»ºï¼ˆä¼˜å…ˆä½¿ç”¨ä»“åº“è‡ªå¸¦ laneï¼‰
        script: |
          set -e
          npm run build:android || echo "lane æž„å»ºå¤±è´¥ï¼Œå°è¯• Gradle å…œåº•â€¦"

      - name: å…œåº•ï¼šç›´æŽ¥ Gradle ç”Ÿæˆ APKï¼ˆå¦‚ lane åªäº§å‡º AABï¼‰
        script: |
          set -e
          cd android
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file="$CM_KEYSTORE_PATH" \
            -Pandroid.injected.signing.store.password="$CM_KEY_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$CM_KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$CM_KEY_PASSWORD" || true
          cd -

      - name: æ”¶é›†åˆ¶å“ï¼ˆAPK/AABï¼‰
        script: |
          mkdir -p $CM_ARTIFACTS
          find . -type f -name "*release*.apk" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS \; || true
          find . -type f -name "*.aab" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS \; || true
    # ä¸å†™ publishingï¼šä»…åœ¨ Artifacts è¾“å‡ºå®‰è£…åŒ…

  # ========= iOSï¼šç™½æ ‡ + TestFlight/App Store åˆ†å‘ï¼ˆç”¨ api_key_path æ–¹æ¡ˆï¼‰ =========
  mm-whitelabel-ios:
    name: Mattermost WhiteLabel iOS (TestFlight/App Store)
    max_build_duration: 120
    instance_type: mac_mini_m2

    # å¯é€‰ï¼šå³ä½¿é…ç½®äº† integrationsï¼Œpublishing ç”¨çš„æ˜¯ api_key_pathï¼Œä¸å†²çª
    # integrations:
    #   app_store_connect: codemagic

    environment:
      groups:
        - mm_common
        - jboth_client
        - ios_match
      vars:
        BUILD_FOR_RELEASE: "true"
        REPLACE_ASSETS: "true"
        # å˜é‡ç»„é‡Œéœ€æä¾›ï¼š
        # APP_NAMEã€MAIN_APP_IDENTIFIERã€
        # EXTENSION_APP_IDENTIFIERã€NOTIFICATION_SERVICE_IDENTIFIERã€
        # FASTLANE_TEAM_IDã€IOS_APP_GROUPã€IOS_ICLOUD_CONTAINERã€
        # MATCH_USERNAMEã€MATCH_PASSWORDã€MATCH_GIT_URLã€MATCH_APP_IDENTIFIERã€MATCH_TYPE=appstoreã€SYNC_PROVISIONING_PROFILES=true
        # ä»¥åŠ ASC_KEY_IDã€ASC_ISSUER_IDã€ASC_PRIVATE_KEYï¼ˆApp æˆ– Team çº§çŽ¯å¢ƒå˜é‡ï¼Œè®¾ä¸º Secretï¼‰

    cache:
      cache_paths:
        - $HOME/Library/Caches/CocoaPods
        - ios/Pods
        - node_modules

    scripts:
      # è‹¥ä½ çš„ match ä»“åº“æ˜¯è‡ªå»ºåŸŸåï¼Œå¯å–æ¶ˆæ³¨é‡Šé¢„çƒ­ known_hosts
      # - name: SSH known_hosts
      #   script: |
      #     mkdir -p ~/.ssh && ssh-keyscan your.git.host >> ~/.ssh/known_hosts

      - name: çŽ¯å¢ƒä¸Žä¾èµ–ï¼ˆNodeï¼‰
        script: |
          set -e

          echo "â–¶ Using system Node"
          which node || true
          node -v
          npm -v

          echo "â–¶ Install watchman (solidarity requires it)"
          if command -v brew >/dev/null 2>&1; then
            eval "$(/opt/homebrew/bin/brew shellenv)" || true
            brew list watchman >/dev/null 2>&1 || brew install watchman
            watchman --version || true
          else
            echo "âŒ Homebrew æœªæ‰¾åˆ°ï¼Œæ— æ³•å®‰è£… watchman"
            exit 1
          fi

          echo "â–¶ Pin CocoaPods to 1.16.1 (user gem dir) and bypass Bundler"
          # å®‰è£…åˆ°ç”¨æˆ·ç›®å½•ï¼Œé¿å…åŠ¨ç³»ç»Ÿ Ruby/Gems
          export GEM_HOME="$HOME/.gem"
          export GEM_PATH="$GEM_HOME"
          export PATH="$GEM_HOME/bin:$PATH"
          gem list -i cocoapods -v 1.16.1 || gem install cocoapods -v 1.16.1 --no-document

          # å½»åº•è§„é¿ Bundler æ³¨å…¥ï¼šæ¸…æŽ‰ç›¸å…³çŽ¯å¢ƒå˜é‡ï¼Œå†ç”¨ RubyGems çš„â€œå¯æ‰§è¡Œç‰ˆæœ¬â€è¯­æ³•
          unset RUBYOPT BUNDLE_GEMFILE BUNDLE_BIN_PATH BUNDLE_PATH BUNDLER_ORIG_PATH BUNDLER_ORIG_MANPATH || true
          echo "pod path: $(command -v pod || echo 'not found')"
          env -i PATH="$PATH" GEM_HOME="$GEM_HOME" GEM_PATH="$GEM_PATH" HOME="$HOME" LANG="${LANG:-en_US.UTF-8}" pod _1.16.1_ --version

          echo "â–¶ npm ci"
          npm ci

      - name: Ruby/CocoaPods/Fastlane
        script: |
          gem install bundler --no-document
          bundle install
          cd ios && bundle exec pod install --repo-update && cd ..

      # â€”â€” å…³é”®ï¼šåœ¨ match ä¹‹å‰é…ç½® SSHï¼Œå¹¶è‡ªæ£€è®¿é—®è¯ä¹¦åº“ â€”â€”
      - name: é…ç½®è¯ä¹¦åº“ï¼ˆHTTPS + Tokenï¼‰å¹¶è‡ªæ£€
        script: "set -e; if [ -z \"${GITHUB_PAT:-}\" ]; then echo 'âŒ ç¼ºå°‘ GITHUB_PAT'; exit 1; fi; export MATCH_GIT_URL=\"https://${GITHUB_PAT}@github.com/goodwillworld/ios-certs.git\"; echo 'MATCH_GIT_URL set (token masked)'; git -c credential.helper= ls-remote \"$MATCH_GIT_URL\" >/dev/null; echo 'âœ… match è¯ä¹¦åº“å¯è®¿é—®ï¼ˆHTTPS+Tokenï¼‰'; export SIGH_GIT_URL=\"$MATCH_GIT_URL\""

      - name: è‡ªæ£€å…³é”®å˜é‡ï¼ˆä¸ä¼šæ³„éœ²ï¼‰
        script: |
          set -e
          check_var() { if [ -z "${!1}" ]; then echo "âŒ MISSING $1"; exit 1; else echo "âœ… $1 OK"; fi; }
          check_var FASTLANE_TEAM_ID
          check_var MATCH_USERNAME
          check_var MATCH_PASSWORD
          check_var MATCH_GIT_URL
          check_var MATCH_APP_IDENTIFIER
          check_var MATCH_TYPE
          check_var ASC_KEY_ID
          check_var ASC_ISSUER_ID
          if [ -z "$ASC_PRIVATE_KEY" ]; then echo "âŒ MISSING ASC_PRIVATE_KEY"; exit 1; else echo "âœ… ASC_PRIVATE_KEY OK (hidden)"; fi

      - name: è¯Šæ–­å¹¶é¢„å…ˆæ‹‰å– match ä»“åº“ï¼ˆHTTPS+Tokenï¼Œè‡ªåŠ¨å®‰è£… fastlaneï¼‰
        script: |
          set -e

          # 0) åŸºç¡€å˜é‡æ£€æŸ¥ï¼ˆè¿™å‡ ä¸ªå¿…é¡»æœ‰ï¼‰
          : "${MATCH_USERNAME:?ç¼ºå°‘ MATCH_USERNAME(Apple ID)}"
          : "${MATCH_PASSWORD:?ç¼ºå°‘ MATCH_PASSWORD(matchåŠ å¯†å£ä»¤)}"
          : "${FASTLANE_TEAM_ID:?ç¼ºå°‘ FASTLANE_TEAM_ID}"
          : "${MATCH_APP_IDENTIFIER:?ç¼ºå°‘ MATCH_APP_IDENTIFIER}"

          # 1) è¯ä¹¦åº“åœ°å€ï¼ˆä¼˜å…ˆç”¨å·²æœ‰çš„ MATCH_GIT_URLï¼›æ²¡æœ‰å°±ç”¨ GITHUB_PAT ç»„è£… HTTPS åœ°å€ï¼‰
          if [ -z "${MATCH_GIT_URL:-}" ]; then
            : "${GITHUB_PAT:?ç¼ºå°‘ GITHUB_PAT æˆ– MATCH_GIT_URL}"
            export MATCH_GIT_URL="https://${GITHUB_PAT}@github.com/goodwillworld/ios-certs.git"
          fi
          export SIGH_GIT_URL="$MATCH_GIT_URL"   # é˜²æ­¢è¢« Matchfile è¦†ç›–

          echo "MATCH_GIT_URL set (token masked)"

          # 2) è‡ªæ£€ï¼šè¯ä¹¦åº“å¯è®¿é—®ï¼ˆç”¨ HTTPS+Tokenï¼‰
          git -c credential.helper= ls-remote "$MATCH_GIT_URL" >/dev/null
          echo "âœ… match è¯ä¹¦åº“å¯è®¿é—®ï¼ˆHTTPS+Tokenï¼‰"

          # 3) å®‰è£… fastlaneï¼ˆæŒ‰éœ€ï¼‰
          if [ -f Gemfile ] && grep -qi 'fastlane' Gemfile; then
            echo "â–¶ Gemfile æ£€æµ‹åˆ° fastlaneï¼Œä½¿ç”¨ bundler"
            gem install bundler --no-document
            bundle install
            FASTLANE="bundle exec fastlane"
          else
            echo "â–¶ æœªæ£€æµ‹åˆ° Gemfile ä¸­çš„ fastlaneï¼Œç›´æŽ¥å®‰è£… gem"
            gem install fastlane -v 2.228.0 --no-document || gem install fastlane --no-document
            FASTLANE="fastlane"
          fi
          $FASTLANE --version

          # 4) é¢„æ‹‰å–å¹¶è§£å¯†è¯ä¹¦ï¼ˆreadonly=true ä¸ä¼šæ”¹åŠ¨è¿œç«¯ï¼‰
          #    è‹¥ä½ çš„è¯ä¹¦åº“å·²ç»ç”¨ match åˆå§‹åŒ–è¿‡ï¼Œè¿™ä¸€æ­¥ä¼šç”¨ MATCH_PASSWORD è§£å¯†
          $FASTLANE run match \
            type:"appstore" \
            readonly:"true" \
            git_url:"$MATCH_GIT_URL" \
            app_identifier:"$MATCH_APP_IDENTIFIER" \
            team_id:"$FASTLANE_TEAM_ID" \
            verbose:true

      - name: é¦–æ¬¡åˆå§‹åŒ–ç­¾åï¼ˆä»…å½“è¯ä¹¦åº“ä¸ºç©ºæ—¶æ‰§è¡Œï¼‰
        script: |
          set -e

          # 0) å¿…è¦å˜é‡
          : "${MATCH_GIT_URL:?ç¼ºå°‘ MATCH_GIT_URLï¼ˆå·²ç”¨ HTTPS+Token è‡ªæ£€é€šè¿‡ï¼‰}"
          : "${FASTLANE_TEAM_ID:?ç¼ºå°‘ FASTLANE_TEAM_ID}"
          : "${MATCH_APP_IDENTIFIER:?ç¼ºå°‘ MATCH_APP_IDENTIFIERï¼ˆå¯é€—å·åˆ†éš”å¤šä¸ªIDï¼‰}"
          : "${ASC_KEY_ID:?ç¼ºå°‘ ASC_KEY_ID}"
          : "${ASC_ISSUER_ID:?ç¼ºå°‘ ASC_ISSUER_ID}"
          : "${ASC_PRIVATE_KEY:?ç¼ºå°‘ ASC_PRIVATE_KEY}"

          # 1) æ£€æµ‹ä»“åº“æ˜¯å¦ä¸ºç©ºï¼ˆæ— ä»»ä½•åˆ†æ”¯ï¼‰
          if [ "$(git -c credential.helper= ls-remote --heads "$MATCH_GIT_URL" | wc -l | tr -d ' ')" -gt 0 ]; then
            echo "â„¹ï¸ è¯ä¹¦åº“éžç©ºï¼Œè·³è¿‡åˆå§‹åŒ–ï¼ˆå°†æ²¿ç”¨å·²æœ‰è¯ä¹¦/æè¿°æ–‡ä»¶ï¼‰"
            exit 0
          fi
          echo "ðŸ†• æ£€æµ‹åˆ°ç©ºä»“åº“ï¼šæ‰§è¡Œé¦–è½®åˆå§‹åŒ–ï¼ˆåˆ›å»ºè¯ä¹¦/æè¿°æ–‡ä»¶å¹¶ pushï¼‰"

          # 2) å‡†å¤‡ fastlaneï¼ˆæœ‰ Gemfile å°±ç”¨ bundlerï¼Œæ²¡æœ‰å°± gem å®‰è£…ï¼‰
          if [ -f Gemfile ] && grep -qi 'fastlane' Gemfile; then
            gem install bundler --no-document
            bundle install
            FL="bundle exec fastlane"
          else
            gem install fastlane -v 2.228.0 --no-document || gem install fastlane --no-document
            FL="fastlane"
          fi
          $FL --version

          # 3) ç”Ÿæˆ ASC API Key JSONï¼ˆä¾› match ä½¿ç”¨ï¼‰
          cat > asc_api_key.json <<EOF
          {
            "key_id":    "${ASC_KEY_ID}",
            "issuer_id": "${ASC_ISSUER_ID}",
            "key":       "${ASC_PRIVATE_KEY}",
            "in_house":  false
          }
          EOF

          # 4) å»ºä¸€ä¸ªä¸´æ—¶ keychainï¼ˆé¿å…ç³»ç»Ÿé’¥åŒ™ä¸²äº¤äº’ï¼‰
          KEYCHAIN_PWD="${KEYCHAIN_PWD:-$(uuidgen)}"
          $FL run create_keychain name:"cm_tmp" password:"$KEYCHAIN_PWD" default_keychain:true unlock:true timeout:3600

          # 5) è®¾å®š git ç”¨æˆ·ä¿¡æ¯ï¼ˆä¾¿äºŽ push é¦–æ¬¡æäº¤ï¼‰
          git config --global user.email "codemagic@local"
          git config --global user.name  "Codemagic CI"

          # 6) ç”¨ App Store Connect API Key é¦–æ¬¡åˆ›å»ºï¼ˆåªè¿™ä¸€æ¬¡ readonly:falseï¼‰
          $FL run match \
            type:"appstore" \
            readonly:"false" \
            git_url:"$MATCH_GIT_URL" \
            app_identifier:"$MATCH_APP_IDENTIFIER" \
            team_id:"$FASTLANE_TEAM_ID" \
            api_key_path:"asc_api_key.json" \
            keychain_name:"cm_tmp" \
            keychain_password:"$KEYCHAIN_PWD" \
            verbose:true

          echo "âœ… é¦–æ¬¡åˆå§‹åŒ–å®Œæˆï¼šåŽç»­æž„å»ºå¯æ”¹å›ž readonly:true"


      # - name: ç”Ÿæˆ App Store Connect API Key JSONï¼ˆä¾› publishing ä½¿ç”¨ï¼‰
            #   script: |
            #     set -e
            #     cat > asc_api_key.json <<EOF
            #     {
            #       "key_id": "${ASC_KEY_ID}",
            #       "issuer_id": "${ASC_ISSUER_ID}",
            #       "key": "${ASC_PRIVATE_KEY}",
            #       "in_house": false
            #     }
            #     EOF
            #     echo "âœ… asc_api_key.json generated"
      - name: æž„å»º iOSï¼ˆä½¿ç”¨ä»“åº“ laneï¼‰
        script: |
          npm run build:ios
      - name: æ”¶é›†åˆ¶å“
        script: |
          mkdir -p $CM_ARTIFACTS
          find . -type f -name "*.ipa" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS \; || true
    publishing:
      app_store_connect:
        api_key: |
          -----BEGIN PRIVATE KEY-----
          MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgTHFCUEmtmzuEaG/T
          zD5C5EBtEBsuWf54ZxCbWmpD/lugCgYIKoZIzj0DAQehRANCAAS6nYsA0zoFzGbY
          t9rYpOKdcq0hG8zmImfhjOct0m609Z/J4fOcoxeLd3LJr4DAo6Kk+PBeCFBvrxIl
          j5J7JvfX
          -----END PRIVATE KEY-----
        key_id: "UZ33M397NY"
        issuer_id: "26e601c9-c2f0-497a-a9e1-39a426cecf9a"
        submit_to_testflight: true