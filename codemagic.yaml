workflows:
  mm-whitelabel-android-sideload:
    name: Mattermost WhiteLabel ANDROID (sideload)
    max_build_duration: 120
    instance_type: linux_x2
    environment:
      android_signing:
        - jboth_android_keystore_ref
      groups:
        - mm_common
        - jboth_client
      vars:
        BUILD_FOR_RELEASE: "true"
        ANDROID_BUILD_TASK: assemble
        REPLACE_ASSETS: "true"
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - node_modules
    scripts:
      - name: Node ç¯å¢ƒä¸ä¾èµ–
        script: |
          set -e
          export NVM_DIR="$HOME/.nvm"
          if [ -f ".nvmrc" ] && [ -s "$NVM_DIR/nvm.sh" ]; then
            . "$NVM_DIR/nvm.sh"
            nvm install --silent
            nvm use --silent
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ° nvmï¼Œä½¿ç”¨ç³»ç»Ÿ Node"
            which node || true
            node -v || true
            npm -v || true
          fi
          npm ci
      - name: æ³¨å…¥ç­¾åï¼ˆGradleï¼‰
        script: |
          mkdir -p $HOME/.gradle
          cat >> $HOME/.gradle/gradle.properties <<EOF
          MATTERMOST_RELEASE_STORE_FILE=$CM_KEYSTORE_PATH
          MATTERMOST_RELEASE_KEY_ALIAS=$CM_KEY_ALIAS
          MATTERMOST_RELEASE_PASSWORD=$CM_KEY_PASSWORD
          EOF
      - name: å†™å…¥/å…œåº•é»˜è®¤æœåŠ¡å™¨é…ç½®ï¼ˆå¦‚ä»“åº“ä¸­å·²å­˜åœ¨å°†ä¸ä¼šè¦†ç›–ï¼‰
        script: |
          set -e
          mkdir -p assets/override
          CFG=assets/override/config.json
          if [ ! -f "$CFG" ]; then
            cat > "$CFG" <<'JSON'
          {
            "DefaultServerUrl": "https://hello.jboth.com",
            "AutoSelectServerUrl": true
          }
          JSON
            echo "Created $CFG with default server URL."
          else
            echo "Found existing $CFG, keep your repo version."
          fi
      - name: ç™½æ ‡å˜é‡ç¡®è®¤
        script: |
          echo "APP_NAME=$APP_NAME"
          echo "MAIN_APP_IDENTIFIER=$MAIN_APP_IDENTIFIER"
          echo "APP_SCHEME=$APP_SCHEME"
      - name: æ„å»ºï¼ˆä¼˜å…ˆä½¿ç”¨ä»“åº“è‡ªå¸¦ laneï¼‰
        script: |
          set -e
          npm run build:android || echo "lane æ„å»ºå¤±è´¥ï¼Œå°è¯• Gradle å…œåº•â€¦"
      - name: å…œåº•ï¼šç›´æ¥ Gradle ç”Ÿæˆ APKï¼ˆå¦‚ lane åªäº§å‡º AABï¼‰
        script: |
          set -e
          cd android
          ./gradlew assembleRelease             -Pandroid.injected.signing.store.file="$CM_KEYSTORE_PATH"             -Pandroid.injected.signing.store.password="$CM_KEY_PASSWORD"             -Pandroid.injected.signing.key.alias="$CM_KEY_ALIAS"             -Pandroid.injected.signing.key.password="$CM_KEY_PASSWORD" || true
          cd -
      - name: æ”¶é›†åˆ¶å“ï¼ˆAPK/AABï¼‰
        script: |
          mkdir -p $CM_ARTIFACTS
          find . -type f -name "*release*.apk" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS \; || true
          find . -type f -name "*.aab" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS \; || true

  mm-whitelabel-ios:
    name: Mattermost WhiteLabel iOS (App Store)
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      groups:
        - mm_common
        - jboth_client
        - ios_match
      vars:
        BUILD_FOR_RELEASE: 'true'
        REPLACE_ASSETS: 'true'
        EXPORT_METHOD: app-store
        MATCH_TYPE: appstore
    cache:
      cache_paths:
        - $HOME/Library/Caches/CocoaPods
        - ios/Pods
        - node_modules
    scripts:
      - name: ç¯å¢ƒä¸ä¾èµ–ï¼ˆNode + watchman + CocoaPods 1.16.1ï¼‰
        script: |
          set -e
          echo "â–¶ Node"
          which node || true
          node -v || true
          npm -v || true
          echo "â–¶ Install watchman"
          if command -v brew >/dev/null 2>&1; then
            eval "$(/opt/homebrew/bin/brew shellenv)" || true
            brew list watchman >/dev/null 2>&1 || brew install watchman
            watchman --version || true
          else
            echo "âŒ Homebrew æœªæ‰¾åˆ°"; exit 1
          fi
          echo "â–¶ CocoaPods 1.16.1"
          export GEM_HOME="$HOME/.gem"
          export GEM_PATH="$GEM_HOME"
          export PATH="$GEM_HOME/bin:$PATH"
          gem list -i cocoapods -v 1.16.1 || gem install cocoapods -v 1.16.1 --no-document
          export LANG="${LANG:-en_US.UTF-8}"
          echo "pod path: $(command -v pod || echo 'not found')"
          npm ci
          cd ios
          pod _1.16.1_ install --repo-update
          cd -
      - name: ğŸ”§ Patch Pods project (TurboLogIOSNative module.modulemap hotfix)
        script: |
          set -euo pipefail
          cd ios
          ruby - <<'RUBY'
            require 'xcodeproj'
            proj_path = 'Pods/Pods.xcodeproj'
            proj = Xcodeproj::Project.open(proj_path)
            targets = proj.targets.select { |t| t.name == 'TurboLogIOSNative' }
            if targets.empty?
              puts "â„¹ï¸ Target TurboLogIOSNative not found, skipping"
            else
              targets.each do |t|
                # Remove any *.modulemap from Compile Sources
                phases = []
                phases << (t.respond_to?(:source_build_phase) ? t.source_build_phase : nil)
                phases << (t.respond_to?(:sources_build_phase) ? t.sources_build_phase : nil)
                phases.compact.each do |phase|
                  phase.files_references
                       .select { |fr| (fr.path || '').end_with?('.modulemap') }
                       .each   { |fr| phase.remove_file_reference(fr) }
                end
                # Harden build settings
                t.build_configurations.each do |cfg|
                  cfg.build_settings['EXCLUDED_SOURCE_FILE_NAMES'] = '*/module.modulemap *.modulemap'
                  cfg.build_settings['MODULEMAP_FILE'] = '$(SRCROOT)/TurboLogIOSNative/Sources/TurboLogSwift/module.modulemap'
                  cfg.build_settings['DEFINES_MODULE'] = 'YES'
                end
              end
              proj.save
              puts "âœ… Patched TurboLogIOSNative in Pods.xcodeproj"
            end
          RUBY
          cd -
      - name: ç”Ÿæˆ ASC API Keyï¼ˆä¾› match/gym ä½¿ç”¨ï¼‰
        script: |
          set -e
          python3 - <<'PY'
          import os, json
          data = {
            "key_id": os.environ["ASC_KEY_ID"].strip(),
            "issuer_id": os.environ["ASC_ISSUER_ID"].strip(),
            "key": os.environ["ASC_PRIVATE_KEY"].replace("\r\n", "\n").replace("\r", "\n"),
            "in_house": False
          }
          open("asc_api_key.json","w").write(json.dumps(data))
          PY
          python3 -m json.tool asc_api_key.json >/dev/null 2>&1 || { echo "asc_api_key.json invalid"; exit 1; }
      - name: é…ç½®è¯ä¹¦åº“ï¼ˆHTTPS + Tokenï¼‰å¹¶å†™å…¥åç»­æ­¥éª¤ç¯å¢ƒ
        script: |
          set -e
          if [ -z "${GITHUB_PAT:-}" ]; then echo 'âŒ ç¼ºå°‘ GITHUB_PAT'; exit 1; fi
          URL="https://${GITHUB_PAT}@github.com/goodwillworld/ios-certs.git"
          git -c credential.helper= ls-remote "$URL" >/dev/null
          echo "MATCH_GIT_URL=$URL" >> "$CM_ENV"
          echo "SIGH_GIT_URL=$URL" >> "$CM_ENV"
          echo "âœ… match è¯ä¹¦åº“å¯è®¿é—®ï¼Œå¹¶å·²å†™å…¥ç¯å¢ƒ"
      - name: è‡ªæ£€å…³é”®å˜é‡ï¼ˆä¸ä¼šæ³„éœ²ï¼‰
        script: |
          set -e
          need() { if [ -z "${!1:-}" ]; then echo "âŒ MISSING $1"; exit 1; else echo "âœ… $1 OK"; fi; }
          need FASTLANE_TEAM_ID
          need MATCH_USERNAME
          need MATCH_PASSWORD
          need MATCH_APP_IDENTIFIER
          need MATCH_TYPE
          need ASC_KEY_ID
          need ASC_ISSUER_ID
          if [ -z "${ASC_PRIVATE_KEY:-}" ]; then echo "âŒ MISSING ASC_PRIVATE_KEY"; exit 1; else echo "âœ… ASC_PRIVATE_KEY OK (hidden)"; fi
      - name: æ„å»º iOSï¼ˆä½¿ç”¨ä»“åº“ laneï¼‰
        script: |
          set -e
          npm run build:ios
      - name: æ”¶é›†åˆ¶å“
        script: |
          set -e
          mkdir -p "$CM_ARTIFACTS"
          find . -type f -name "*.ipa" -maxdepth 6 -print -exec cp -f {} "$CM_ARTIFACTS" \; || true
    publishing:
      app_store_connect:
        api_key: $ASC_PRIVATE_KEY
        key_id: $ASC_KEY_ID
        issuer_id: $ASC_ISSUER_ID
        submit_to_testflight: true
