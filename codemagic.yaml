workflows:
  mm-whitelabel-android-sideload:
    name: Mattermost WhiteLabel ANDROID (sideload)
    max_build_duration: 120
    instance_type: linux_x2
    environment:
      android_signing:
      - jboth_android_keystore_ref
      groups:
      - mm_common
      - jboth_client
      vars:
        BUILD_FOR_RELEASE: 'true'
        ANDROID_BUILD_TASK: assemble
        REPLACE_ASSETS: 'true'
    cache:
      cache_paths:
      - $HOME/.gradle/caches
      - node_modules
    scripts:
    - name: Node ç¯å¢ƒä¸ä¾èµ–
      script: "set -e\nexport NVM_DIR=\"$HOME/.nvm\"\nif [ -f \".nvmrc\" ] && [ -s\
        \ \"$NVM_DIR/nvm.sh\" ]; then\n  . \"$NVM_DIR/nvm.sh\"\n  nvm install --silent\n\
        \  nvm use --silent\nelse\n  echo \"âš ï¸ æœªæ£€æµ‹åˆ° nvmï¼Œä½¿ç”¨ç³»ç»Ÿ Node\"\n  which node\
        \ || true\n  node -v || true\n  npm -v || true\nfi\nnpm ci\n"
    - name: æ³¨å…¥ç­¾åï¼ˆGradleï¼‰
      script: 'mkdir -p $HOME/.gradle

        cat >> $HOME/.gradle/gradle.properties <<EOF

        MATTERMOST_RELEASE_STORE_FILE=$CM_KEYSTORE_PATH

        MATTERMOST_RELEASE_KEY_ALIAS=$CM_KEY_ALIAS

        MATTERMOST_RELEASE_PASSWORD=$CM_KEY_PASSWORD

        EOF

        '
    - name: å†™å…¥/å…œåº•é»˜è®¤æœåŠ¡å™¨é…ç½®ï¼ˆå¦‚ä»“åº“ä¸­å·²å­˜åœ¨å°†ä¸ä¼šè¦†ç›–ï¼‰
      script: "set -e\nmkdir -p assets/override\nCFG=assets/override/config.json\n\
        if [ ! -f \"$CFG\" ]; then\n  cat > \"$CFG\" <<'JSON'\n{\n  \"DefaultServerUrl\"\
        : \"https://hello.jboth.com\",\n  \"AutoSelectServerUrl\": true\n}\nJSON\n\
        \  echo \"Created $CFG with default server URL.\"\nelse\n  echo \"Found existing\
        \ $CFG, keep your repo version.\"\nfi\n"
    - name: ç™½æ ‡å˜é‡ç¡®è®¤
      script: 'echo "APP_NAME=$APP_NAME"

        echo "MAIN_APP_IDENTIFIER=$MAIN_APP_IDENTIFIER"

        echo "APP_SCHEME=$APP_SCHEME"

        '
    - name: æ„å»ºï¼ˆä¼˜å…ˆä½¿ç”¨ä»“åº“è‡ªå¸¦ laneï¼‰
      script: 'set -e

        npm run build:android || echo "lane æ„å»ºå¤±è´¥ï¼Œå°è¯• Gradle å…œåº•â€¦"

        '
    - name: å…œåº•ï¼šç›´æ¥ Gradle ç”Ÿæˆ APKï¼ˆå¦‚ lane åªäº§å‡º AABï¼‰
      script: "set -e\ncd android\n./gradlew assembleRelease \\\n  -Pandroid.injected.signing.store.file=\"\
        $CM_KEYSTORE_PATH\" \\\n  -Pandroid.injected.signing.store.password=\"$CM_KEY_PASSWORD\"\
        \ \\\n  -Pandroid.injected.signing.key.alias=\"$CM_KEY_ALIAS\" \\\n  -Pandroid.injected.signing.key.password=\"\
        $CM_KEY_PASSWORD\" || true\ncd -\n"
    - name: æ”¶é›†åˆ¶å“ï¼ˆAPK/AABï¼‰
      script: 'mkdir -p $CM_ARTIFACTS

        find . -type f -name "*release*.apk" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS
        \; || true

        find . -type f -name "*.aab" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS
        \; || true

        '
  mm-whitelabel-ios:
    name: Mattermost WhiteLabel iOS (TestFlight/App Store)
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      groups:
      - mm_common
      - jboth_client
      - ios_match
      vars:
        BUILD_FOR_RELEASE: 'true'
        REPLACE_ASSETS: 'true'
    cache:
      cache_paths:
      - $HOME/Library/Caches/CocoaPods
      - ios/Pods
      - node_modules
    scripts:
    - name: ç¯å¢ƒä¸ä¾èµ–ï¼ˆNode + watchman + CocoaPods 1.16.1ï¼‰
      script: "set -e\necho \"â–¶ Using system Node\"\nwhich node || true\nnode -v ||\
        \ true\nnpm -v || true\n\necho \"â–¶ Install watchmanï¼ˆSolidarity éœ€è¦ï¼‰\"\nif command\
        \ -v brew >/dev/null 2>&1; then\n  eval \"$(/opt/homebrew/bin/brew shellenv)\"\
        \ || true\n  brew list watchman >/dev/null 2>&1 || brew install watchman\n\
        \  watchman --version || true\nelse\n  echo \"âŒ Homebrew æœªæ‰¾åˆ°ï¼Œæ— æ³•å®‰è£… watchman\"\
        ; exit 1\nfi\n\necho \"â–¶ Pin CocoaPods 1.16.1ï¼ˆç”¨æˆ· gem ç›®å½•ï¼‰\"\nexport GEM_HOME=\"\
        $HOME/.gem\"\nexport GEM_PATH=\"$GEM_HOME\"\nexport PATH=\"$GEM_HOME/bin:$PATH\"\
        \ngem list -i cocoapods -v 1.16.1 || gem install cocoapods -v 1.16.1 --no-document\n\
        unset RUBYOPT BUNDLE_GEMFILE BUNDLE_BIN_PATH BUNDLE_PATH BUNDLER_ORIG_PATH\
        \ BUNDLER_ORIG_MANPATH || true\necho \"pod path: $(command -v pod || echo\
        \ 'not found')\"\nenv -i PATH=\"$PATH\" GEM_HOME=\"$GEM_HOME\" GEM_PATH=\"\
        $GEM_PATH\" HOME=\"$HOME\" LANG=\"${LANG:-en_US.UTF-8}\" pod _1.16.1_ --version\n\
        \necho \"â–¶ npm ci\"\nnpm ci\n"
    - name: Ruby/Fastlane + CocoaPodsï¼ˆç”¨å›ºå®šçš„ 1.16.1 æ‰§è¡Œï¼‰
      script: "set -e\n\n# â‘  å¼ºåˆ¶ rbenv ä½¿ç”¨å·²å®‰è£…çš„ Rubyï¼ˆè¦†ç›– .ruby-version çš„ 3.2.0ï¼‰\nif command\
        \ -v rbenv >/dev/null 2>&1; then\n  # å–ä¸€ä¸ªå·²å®‰è£…ç‰ˆæœ¬ï¼ˆä¼˜å…ˆ 3.xï¼‰ï¼Œæ²¡æœ‰å°±ç”¨ system\n  RB_INST=\"\
        $(rbenv versions --bare | grep -E '^[0-9]+\\.[0-9]+' | tail -1 || true)\"\n\
        \  export RBENV_VERSION=\"${RB_INST:-system}\"\n  echo \"Using rbenv Ruby:\
        \ ${RBENV_VERSION}\"\nfi\nruby -v || true\n\n# â‘¡ ä¸´æ—¶â€œå±è”½â€ä»“åº“æ ¹çš„ .ruby-versionï¼Œé˜²æ­¢å­è¿›ç¨‹å†æ¬¡è¯»å–\
        \ 3.2.0\nif [ -f .ruby-version ]; then\n  mv .ruby-version .ruby-version.bak\n\
        \  trap 'mv .ruby-version.bak .ruby-version 2>/dev/null || true' EXIT\nfi\n\
        \n# â‘¢ ä½¿ç”¨æˆ‘ä»¬å·²å®‰è£…åˆ° $HOME/.gem çš„ CocoaPods 1.16.1ï¼ˆä¸èµ° bundlerï¼‰\ncd ios\nRBENV_VERSION=\"\
        ${RBENV_VERSION}\" \\\nGEM_HOME=\"$HOME/.gem\" GEM_PATH=\"$HOME/.gem\" HOME=\"\
        $HOME\" LANG=\"${LANG:-en_US.UTF-8}\" \\\npod _1.16.1_ install --repo-update\n\
        cd ..\n"

    - name: ğŸ”§ Patch Pods project (TurboLogIOSNative module.modulemap hotfix)
      script: |
        set -euo pipefail
        cd ios
        cat > patch_turblog.rb <<'RUBY'
        require 'xcodeproj'
        pods_proj_path = 'Pods/Pods.xcodeproj'
        proj = Xcodeproj::Project.open(pods_proj_path)
        changed = false
        targets = proj.targets.select { |t| t.name == 'TurboLogIOSNative' }
        if targets.empty?
          puts "â„¹ï¸ Target TurboLogIOSNative not found, skipping"
        else
          targets.each do |t|
            phases = []
            phases << t.source_build_phase if t.respond_to?(:source_build_phase)
            phases << t.sources_build_phase if t.respond_to?(:sources_build_phase)
            phases.compact.each do |phase|
              phase.files.each do |bf|
                fr = bf.file_ref
                next unless fr && fr.path && fr.path.end_with?('.modulemap')
                phase.remove_file_reference(fr)
                changed = true
                puts "ğŸ§¹ Removed #{fr.path} from Compile Sources of #{t.name}"
              end
            end
            t.build_configurations.each do |cfg|
              cfg.build_settings['EXCLUDED_SOURCE_FILE_NAMES'] = '*/module.modulemap *.modulemap'
              cfg.build_settings['DEFINES_MODULE'] = 'YES'
              cfg.build_settings['MODULEMAP_FILE'] = '$(SRCROOT)/TurboLogIOSNative/Sources/TurboLogSwift/module.modulemap'
            end
          end
        end
        if changed
          proj.save
          puts "âœ… Patched TurboLogIOSNative in Pods.xcodeproj"
        else
          puts "â„¹ï¸ No changes needed"
        end
        RUBY

        # CocoaPods å®‰è£…çš„ xcodeproj gem å°±èƒ½è·‘
        ruby patch_turblog.rb

        # å…œåº•ï¼šå¦‚æœ Ruby å¤±è´¥ï¼Œç›´æ¥æŠŠ .modulemap ä» pbxproj çš„ Sources æ¡ç›®é‡Œæ‰«æ‰
        if [ $? -ne 0 ]; then
          echo "âš ï¸ Ruby patch failed, applying sed fallback..."
          PBX="Pods/Pods.xcodeproj/project.pbxproj"
          cp "$PBX" "${PBX}.bak"
          # ç§»é™¤å¼•ç”¨åˆ° module.modulemap çš„ PBXBuildFile èŠ‚ç‚¹ï¼ˆå°½é‡ä¿å®ˆï¼‰
          awk 'BEGIN{skip=0}
              /module\.modulemap/ {skip=1}
              skip && /\/\* End PBXBuildFile section \*\// {skip=0}
              !skip {print}' "$PBX" > "${PBX}.tmp" && mv "${PBX}.tmp" "$PBX"
        fi
        cd ..


    - name: é…ç½®è¯ä¹¦åº“ï¼ˆHTTPS + Tokenï¼‰å¹¶è‡ªæ£€
      script: set -e; if [ -z "${GITHUB_PAT:-}" ]; then echo 'âŒ ç¼ºå°‘ GITHUB_PAT'; exit
        1; fi; export MATCH_GIT_URL="https://${GITHUB_PAT}@github.com/goodwillworld/ios-certs.git";
        echo 'MATCH_GIT_URL set (token masked)'; git -c credential.helper= ls-remote
        "$MATCH_GIT_URL" >/dev/null; echo 'âœ… match è¯ä¹¦åº“å¯è®¿é—®ï¼ˆHTTPS+Tokenï¼‰'; export SIGH_GIT_URL="$MATCH_GIT_URL"
    - name: è‡ªæ£€å…³é”®å˜é‡ï¼ˆä¸ä¼šæ³„éœ²ï¼‰
      script: 'set -e

        check_var() { if [ -z "${!1}" ]; then echo "âŒ MISSING $1"; exit 1; else echo
        "âœ… $1 OK"; fi; }

        check_var FASTLANE_TEAM_ID

        check_var MATCH_USERNAME

        check_var MATCH_PASSWORD

        check_var MATCH_GIT_URL

        check_var MATCH_APP_IDENTIFIER

        check_var MATCH_TYPE

        check_var ASC_KEY_ID

        check_var ASC_ISSUER_ID

        if [ -z "$ASC_PRIVATE_KEY" ]; then echo "âŒ MISSING ASC_PRIVATE_KEY"; exit
        1; else echo "âœ… ASC_PRIVATE_KEY OK (hidden)"; fi

        '
    - name: è‹¥ç¼ºå¤±åˆ™åˆ›å»º App IDï¼ˆä½¿ç”¨ ASC API Keyï¼‰
      script: "set -e\n: \"${ASC_KEY_ID:?ç¼ºå°‘ ASC_KEY_ID}\"\n: \"${ASC_ISSUER_ID:?ç¼ºå°‘\
        \ ASC_ISSUER_ID}\"\n: \"${ASC_PRIVATE_KEY:?ç¼ºå°‘ ASC_PRIVATE_KEY}\"\n: \"${FASTLANE_TEAM_ID:?ç¼ºå°‘\
        \ FASTLANE_TEAM_ID}\"\n\n# 1) å‡†å¤‡ fastlaneï¼ˆæœ‰ Gemfile ç”¨ bundlerï¼Œå¦åˆ™ç”¨ gemï¼‰\nif\
        \ [ -f Gemfile ] && grep -qi 'fastlane' Gemfile; then\n  gem install bundler\
        \ --no-document\n  bundle install\n  FL=\"bundle exec fastlane\"\nelse\n \
        \ gem install fastlane -v 2.228.0 --no-document || gem install fastlane --no-document\n\
        \  FL=\"fastlane\"\nfi\n$FL --version\n\n# 2) ç”Ÿæˆ ASC API Key JSONï¼ˆå®‰å…¨è½¬ä¹‰ï¼‰\n\
        python3 - <<'PY'\nimport os, json\ndata={\n  \"key_id\": os.environ[\"ASC_KEY_ID\"\
        ].strip(),\n  \"issuer_id\": os.environ[\"ASC_ISSUER_ID\"].strip(),\n  \"\
        key\": os.environ[\"ASC_PRIVATE_KEY\"].replace(\"\\r\\n\",\"\\n\").replace(\"\
        \\r\",\"\\n\"),\n  \"in_house\": False\n}\nopen(\"asc_api_key.json\",\"w\"\
        ).write(json.dumps(data))\nPY\npython3 -m json.tool asc_api_key.json >/dev/null\
        \ && echo \"âœ… asc_api_key.json OK\"\n\n# 3) éœ€è¦çš„ 3 ä¸ª bundle idï¼ˆä¸» App + Share\
        \ Extension + Notification Serviceï¼‰\nAPP_NAME_CN=\"${APP_NAME:-åŠ æ­¥ååŒ}\"  #\
        \ ä½œä¸ºä¸» App çš„åå­—ï¼›æ‰©å±•ç”¨æ´¾ç”Ÿå\nMAIN=\"com.jboth.mine\"\nSHARE=\"com.jboth.mine.MattermostShare\"\
        \nNTFY=\"com.jboth.mine.NotificationService\"\n\n# 4) ç”¨ produce æŒ‰éœ€åˆ›å»ºï¼ˆå­˜åœ¨åˆ™è·³è¿‡ï¼‰\n\
        create_if_missing() {\n  local bid=\"$1\"; local name=\"$2\"\n  echo \"â–¶ ç¡®ä¿å­˜åœ¨\
        \ App ID: $bid ($name)\"\n  $FL run produce \\\n    app_identifier:\"$bid\"\
        \ \\\n    app_name:\"$name\" \\\n    skip_itc:\"true\" \\\n    team_id:\"\
        $FASTLANE_TEAM_ID\" \\\n    api_key_path:\"asc_api_key.json\" \\\n    run_if:\"\
        true\" \\\n    verbose:true || true\n}\n\ncreate_if_missing \"$MAIN\"  \"\
        $APP_NAME_CN\"\ncreate_if_missing \"$SHARE\" \"${APP_NAME_CN} Share Extension\"\
        \ncreate_if_missing \"$NTFY\"  \"${APP_NAME_CN} Notification Service\"\n\n\
        echo \"âœ… App IDs ensured.\"\n"
    - name: é¦–æ¬¡åˆå§‹åŒ–ç­¾åï¼ˆä»…å½“è¯ä¹¦åº“ä¸ºç©ºæ—¶æ‰§è¡Œï¼‰
      script: "set -e\n: \"${MATCH_GIT_URL:?ç¼ºå°‘ MATCH_GIT_URL}\"\n: \"${FASTLANE_TEAM_ID:?ç¼ºå°‘\
        \ FASTLANE_TEAM_ID}\"\n: \"${MATCH_APP_IDENTIFIER:?ç¼ºå°‘ MATCH_APP_IDENTIFIERï¼ˆé€—å·åˆ†éš”å¤šä¸ªIDï¼‰}\"\
        \n: \"${ASC_KEY_ID:?ç¼ºå°‘ ASC_KEY_ID}\"\n: \"${ASC_ISSUER_ID:?ç¼ºå°‘ ASC_ISSUER_ID}\"\
        \n: \"${ASC_PRIVATE_KEY:?ç¼ºå°‘ ASC_PRIVATE_KEY}\"\n\n# ä»“åº“æ˜¯å¦ä¸ºç©ºï¼ˆæ— åˆ†æ”¯ï¼‰\nif [ \"$(git\
        \ -c credential.helper= ls-remote --heads \"$MATCH_GIT_URL\" | wc -l | tr\
        \ -d ' ')\" -gt 0 ]; then\n  echo \"â„¹ï¸ è¯ä¹¦åº“éç©ºï¼Œè·³è¿‡åˆå§‹åŒ–\"\n  exit 0\nfi\necho \"\
        \U0001F195 ç©ºä»“åº“ï¼šæ‰§è¡Œé¦–è½®åˆå§‹åŒ–ï¼ˆåˆ›å»ºè¯ä¹¦/æè¿°æ–‡ä»¶å¹¶ pushï¼‰\"\n\n# å®‰è£… fastlaneï¼ˆæŒ‰éœ€ï¼‰\nif [ -f Gemfile\
        \ ] && grep -qi 'fastlane' Gemfile; then\n  gem install bundler --no-document\n\
        \  bundle install\n  FL=\"bundle exec fastlane\"\nelse\n  gem install fastlane\
        \ -v 2.228.0 --no-document || gem install fastlane --no-document\n  FL=\"\
        fastlane\"\nfi\n$FL --version\n\n# ç”Ÿæˆ ASC API Key JSONï¼ˆå®‰å…¨è½¬ä¹‰ï¼‰\npython3 - <<'PY'\n\
        import os, json\ndata={\n  \"key_id\": os.environ[\"ASC_KEY_ID\"].strip(),\n\
        \  \"issuer_id\": os.environ[\"ASC_ISSUER_ID\"].strip(),\n  \"key\": os.environ[\"\
        ASC_PRIVATE_KEY\"].replace(\"\\r\\n\",\"\\n\").replace(\"\\r\",\"\\n\"),\n\
        \  \"in_house\": False\n}\nopen(\"asc_api_key.json\",\"w\").write(json.dumps(data))\n\
        PY\npython3 -m json.tool asc_api_key.json >/dev/null && echo \"âœ… asc_api_key.json\
        \ OK\"\n\n# ä¸´æ—¶ keychainï¼Œé¿å…äº¤äº’\nKEYCHAIN_PWD=\"${KEYCHAIN_PWD:-$(uuidgen)}\"\
        \n$FL run create_keychain name:\"cm_tmp\" password:\"$KEYCHAIN_PWD\" default_keychain:true\
        \ unlock:true timeout:3600\n\n# Git ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºé¦–æ¬¡æäº¤ï¼‰\ngit config --global user.email\
        \ \"codemagic@local\"\ngit config --global user.name  \"Codemagic CI\"\n\n\
        # é¦–è½®åˆ›å»ºï¼ˆreadonly:falseï¼‰\n$FL run match \\\n  type:\"appstore\" \\\n  readonly:\"\
        false\" \\\n  git_url:\"$MATCH_GIT_URL\" \\\n  app_identifier:\"$MATCH_APP_IDENTIFIER\"\
        \ \\\n  team_id:\"$FASTLANE_TEAM_ID\" \\\n  api_key_path:\"asc_api_key.json\"\
        \ \\\n  keychain_name:\"cm_tmp\" \\\n  keychain_password:\"$KEYCHAIN_PWD\"\
        \ \\\n  verbose:true\n\necho \"âœ… åˆå§‹åŒ–å®Œæˆï¼šåç»­ match å¯åªè¯»\"\n"
    
    - name: ç»Ÿä¸€å¯¼å‡ºæ–¹å¼ä¸º app-storeï¼ˆé¿å…ç­¾åä¸åŒ¹é…ï¼‰
      script: |
        set -e
        export GYM_EXPORT_METHOD=app-store
        export FL_GYM_EXPORT_METHOD=app-store
        export SIGH_PROFILE_TYPE=app-store
        echo "GYM_EXPORT_METHOD=$GYM_EXPORT_METHOD"
        echo "FL_GYM_EXPORT_METHOD=$FL_GYM_EXPORT_METHOD"
        echo "SIGH_PROFILE_TYPE=$SIGH_PROFILE_TYPE"


    - name: æ”¾å®½ xcodebuild settings è¶…æ—¶
      script: |
        export FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT=120
        echo "FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT=$FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"

    - name: é‡æ–°ç”Ÿæˆ App Store æè¿°æ–‡ä»¶å¹¶å®‰è£…ï¼ˆåŒ…å« App Groupsï¼‰
      script: |
        set -e
        if [ -f Gemfile ] && grep -qi fastlane Gemfile; then
          gem install bundler --no-document
          bundle install
          FL="bundle exec fastlane"
        else
          gem install fastlane -v 2.228.0 --no-document || gem install fastlane --no-document
          FL="fastlane"
        fi
        $FL run match \
          type:"appstore" \
          readonly:"false" \
          force:"true" \
          app_identifier:"com.jboth.mine,com.jboth.mine.MattermostShare,com.jboth.mine.NotificationService" \
          team_id:"$FASTLANE_TEAM_ID" \
          username:"$MATCH_USERNAME" \
          git_url:"$MATCH_GIT_URL" \
          verbose:true


    - name: æ„å»º iOSï¼ˆä½¿ç”¨ä»“åº“ laneï¼‰
      script: 'set -e

        npm run build:ios

        '
    - name: æ‰“å° gym è¯¦ç»†æ—¥å¿—ï¼ˆè‹¥å­˜åœ¨ï¼‰
      script: |
        LOG="$HOME/Library/Logs/gym/Mattermost-Mattermost.log"
        if [ -f "$LOG" ]; then
          echo "===== BEGIN gym log ====="
          tail -n +1 "$LOG" | sed -e 's/\r$//'
          echo "===== END gym log ====="
        else
          echo "No gym log found at $LOG"
        fi


    - name: æ”¶é›†åˆ¶å“
      script: 'mkdir -p $CM_ARTIFACTS

        find . -type f -name "*.ipa" -maxdepth 6 -print -exec cp -f {} $CM_ARTIFACTS
        \; || true

        '
    publishing:
      app_store_connect:
        api_key: '-----BEGIN PRIVATE KEY-----

          MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgTHFCUEmtmzuEaG/T

          zD5C5EBtEBsuWf54ZxCbWmpD/lugCgYIKoZIzj0DAQehRANCAAS6nYsA0zoFzGbY

          t9rYpOKdcq0hG8zmImfhjOct0m609Z/J4fOcoxeLd3LJr4DAo6Kk+PBeCFBvrxIl

          j5J7JvfX

          -----END PRIVATE KEY-----

          '
        key_id: UZ33M397NY
        issuer_id: 26e601c9-c2f0-497a-a9e1-39a426cecf9a
        submit_to_testflight: true
