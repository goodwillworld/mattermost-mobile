workflows:
  ios-publish:
    name: Build and Publish iOS
    instance_type: mac_mini_m2  # 或 mac_pro 为更快构建
    max_build_duration: 60
    environment:
      vars:
        BUNDLE_ID: "com.jboth.mine"  # 匹配您的 Bundle ID
        APP_NAME: "Mattermost"  # 假设 Scheme 为 Mattermost，请确认
        MATCH_CERTIFICATE_PATH: "{{ DistributionCert }}"  # Codemagic UI 中的证书 Reference name
        MATCH_PROVISIONING_PROFILE_UUID: "{{ AppStoreProfile }}"  # Codemagic UI 中的配置文件 Reference name
        CI: "true"  # 触发跳过 Solidarity
    scripts:
      - name: Clean up parent directory
        script: |
          # 删除 /Users/builder 中无关的 Yarn 文件
          rm -f /Users/builder/package.json /Users/builder/yarn.lock
      - name: Get packages
        script: |
          cd /Users/builder/clone
          yarn install --frozen-lockfile  # 使用锁文件，避免更新
      - name: Install CocoaPods
        script: |
          cd /Users/builder/clone/ios
          gem uninstall cocoapods -a -x  # 确保版本兼容
          gem install cocoapods -v 1.16.1
          pod install
      - name: Build iOS
        script: |
          cd /Users/builder/clone/ios
          xcode-project use-profiles
          xcode-project build-ipa --workspace Mattermost.xcworkspace --scheme "$APP_NAME"
    artifacts:
      - ios/ipa/*.ipa
    publishing:
      email:
        recipients:
          - bill.fan4java@gmail.com  # 测试通知
      app_store_connect:
        api_key: "$jboth_app_store_connect"  # 引用 Codemagic UI 中配置的 API 密钥
        key_id: "UZ33M397NY"  # 您的 Key ID
        issuer_id: "26e601c9-c2f0-497a-a9e1-39a426cecf9a"  # 替换为您的 Issuer ID
        submit_to_testflight: true  # 先测试，再设为 app_store